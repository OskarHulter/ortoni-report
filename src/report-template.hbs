<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playwright Test Report</title>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.css">
    <style>
        main.container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .header {
            display: grid;
            grid-template-columns: 1fr 2fr;
            grid-column-gap: 20px;
            grid-row-gap: 20px;
            justify-items: stretch;
            align-items: center;
            justify-content: space-evenly;
        }

        .text-success {
            color: #28a745;
        }

        .text-failure {
            color: #dc3545;
        }

        .text-skip {
            color: #d5d4a1;
        }

        .text-flaky {
            color: #35d6dc;
        }

        .sidebar {
            border-right: 1px solid #ddd;
            padding-right: 10px;
        }

        .card {
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            background-color: #fff;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        }

        pre {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }

        .back-button {
            display: none;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <header class="container">
        <div class="header">
            <div>
                <h1>Playwright Test Report</h1>
            </div>
            <div>
                <form role="search">
                    <input name="search" type="search" placeholder="Search" />
                    <input type="submit" value="Search" />
                </form>
            </div>
        </div>
    </header>
    <main class="container">
        <aside class="sidebar">
            <h2>Tests</h2>
            <div class="">
                {{#each groupedResults}}
                <details>
                    <summary>{{@key}}</summary>
                    <ul>
                        {{#each this}}
                        <details>
                            <summary>{{@key}}</summary>
                            <ul>
                                {{#each this}}
                                <details>
                                    <summary>{{@key}}</summary>
                                    <ul>
                                        {{#each this}}
                                        <li data-suite-name="{{suite}}" data-project-name="{{projectName}}"
                                            data-test-id="{{index}}">{{title}}</li>
                                        {{/each}}
                                    </ul>
                                </details>
                                {{/each}}
                            </ul>
                        </details>
                        {{/each}}
                    </ul>
                </details>
                {{/each}}
            </div>
        </aside>



        <section>
            <div id="summary">
                <section class="grid">
                    <div>
                        <article>
                            <header>Total Tests</header>
                            <p>{{totalCount}}</p>
                        </article>
                    </div>
                    <div>
                        <article>
                            <header>Passed</header>
                            <p class="text-success">{{passCount}}</p>
                        </article>
                    </div>
                    <div>
                        <article>
                            <header>Failed</header>
                            <p class="text-failure">{{failCount}}</p>
                        </article>
                    </div>
                </section>
                <section class="grid">
                    <div>
                        <article>
                            <header>Skipped</header>
                            <p>{{skipCount}}</p>
                        </article>
                    </div>
                    <div>
                        <article>
                            <header>Flaky</header>
                            <p class="text-success">{{flakyCount}}</p>
                        </article>
                    </div>
                </section>
                <section>
                    <h2>Test Results</h2>
                    <div class="chart-container">
                        <canvas id="testChart"></canvas>
                    </div>
                </section>
            </div>

            <div id="testDetails" style="display: none;">
                <!-- Back button should be outside the dynamic content -->
                <button class="back-button" onclick="showSummary()">Back to Summary</button>
                <!-- Test Details will be displayed here -->
            </div>
        </section>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const testData = {{{ json results }}};
        const testDetails = document.getElementById('testDetails');
        const summary = document.getElementById('summary');
        const backButton = document.querySelector('.back-button');

        function showSummary() {
            summary.style.display = 'block';
            testDetails.style.display = 'none';
            backButton.style.display = 'none';
        }

        window.showSummary = showSummary;

        function displayTestDetails(test) {
            summary.style.display = 'none';
            testDetails.style.display = 'block';
            backButton.style.display = 'block';
            testDetails.innerHTML = `
                    <button class="back-button" style="display: block" onclick="showSummary()">Back to Summary</button>
                    <h2>${test.title}</h2>
                    <div class="grid">
                        <div>
                            <h3>Status</h3>
                            <p class="${test.status === 'passed' ? 'text-success' : 'text-failure'}">${test.status}</p>
                            <h3>Duration</h3>
                            <p>${test.duration}ms</p>
                            ${test.errors.length ? `
                            <h3>Errors</h3>
                            <pre>${test.errors.join('\n')}</pre>
                            ` : ''}
                        </div>
                        <div>
                            ${test.screenshotPath ? `
                            <h3>Screenshot</h3>
                            <img src="${test.screenshotPath}" alt="Screenshot">
                            ` : ''}
                            ${test.logs ? `
                            <h3>Logs</h3>
                            <pre>${test.logs}</pre>
                            ` : ''}
                        </div>
                    </div>
                `;
        }

        const testItems = document.querySelectorAll('[data-test-id]');
        testItems.forEach(item => {
            item.addEventListener('click', () => {
                const testId = item.getAttribute('data-test-id');
                const test = testData[testId];
                displayTestDetails(test);
            });
        });

        const ctx = document.getElementById('testChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Passed', 'Failed', 'Skipped'],
                datasets: [{
                    data: [{{ passCount }}, {{ failCount }}, {{ skipCount }}],
            backgroundColor: ['#28a745', '#dc3545', '#d5d4a1']
                    }]
                },
            options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
            });
        });
    </script>
</body>

</html>